<!DOCTYPE html>
<html>
<head>
    <title>Example Chunked Uploader</title>
</head>
<body>

<input id="file-to-upload" type="file">
<button id="upload-button">Upload</button>
<button id="pause-button">Pause</button>
<button id="resume-button">Resume</button>

<script>
    var uploadBtn = document.getElementById('upload-button');
    var pauseBtn = document.getElementById('pause-button');
    var resumeBtn = document.getElementById('resume-button');

    var progress = function(progress) {
        console.log('Total file progress is ' + Math.floor(progress * 100) + '%');
    };

    var success = function(responseText) {
        console.log(responseText);
    };

    function doUpload(url, sessionID, file) {
        var offset = 0;
        var chunkSize = 2; // 2 bytes
        var extraParams = "test=1";
        var xhr;
        var aborting = false;
        var TO = null;

        var uploadNextChunk = function() {
            var chunkStart = offset;
            var chunkEnd = Math.min(offset + chunkSize, file.size) - 1;

            var currentBlob = file.slice(chunkStart, chunkEnd + 1);

            xhr = new XMLHttpRequest();

            if (chunkEnd === file.size - 1) {
                // The last chunk
                xhr.open('POST', url + extraParams, true);
            } else {
                xhr.open('POST', url, true);
            }

            xhr.upload.addEventListener('progress', function(e) {
                if (aborting) {
                    return;
                }

                progress((chunkStart + e.loaded) / file.size);
            });

            xhr.addEventListener('load', function() {
                if (aborting) {
                    return;
                }

                if (xhr.readyState >= 4) {
                    if (xhr.status === 200) {
                        progress((chunkEnd + 1) / file.size);

                        // Done
                        success(xhr.responseText);

                    } else if (xhr.status === 201) {
                        offset = chunkEnd + 1;
                        progress(offset / file.size);

                        // Upload next chunk，这里使用 timeout 仅仅为了测试
                        TO = setTimeout(uploadNextChunk, 1000);
                    } else {
                        try {
                            xhr.abort();
                        } catch (err) {}

                        alert('A server error occurred: ' + xhr.responseText);
                    }
                }
            });

            xhr.setRequestHeader('Content-Type', 'application/octet-stream');
            xhr.setRequestHeader('Content-Disposition', 'attachment; filename="' + encodeURIComponent(file.name) + '"');
            xhr.setRequestHeader('X-Content-Range', 'bytes ' + chunkStart + '-' + chunkEnd + '/' + file.size);
            xhr.setRequestHeader('X-Session-ID', sessionID);

            xhr.send(currentBlob);
        };

        uploadNextChunk();

        return {
            abort: function() {
                aborting = true;
                if (TO !== null) {
                    clearTimeout(TO);
                    TO = null;
                }
                try {
                    xhr.abort();
                } catch (err) {}
            },
            pause: function() {
                this.abort();
                aborting = false;
            },
            resume: function() {
                // 每次重启后
                uploadNextChunk();
            }
        };
    }

    var uploader = null;

    // 上传文件
    uploadBtn.addEventListener('click', function() {
        var file = document.getElementById('file-to-upload').files[0];
        if (!file) {
            return false;
        }

        var sessionID = Math.round(Math.pow(10,17)*Math.random()) + '';

        uploader = doUpload('/upload', sessionID, file);
    });

    // 恢复上传
    resumeBtn.addEventListener('click', function() {
        if (!uploader) {
            return false;
        }

        uploader.resume();
    });

    // 暂停上传
    pauseBtn.addEventListener('click', function() {
        if (!uploader) {
            return false;
        }

        uploader.pause();
    });

</script>

</body>
</html>